<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Contract Signing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 24px;
      background: #f9f9f9;
    }
    button {
      padding: 12px 18px;
      font-size: 16px;
      cursor: pointer;
    }
    .status {
      margin-top: 16px;
      font-weight: bold;
    }
    .success { color: green; }
    .error { color: red; }
    #legalStamp {
      display: none;
      margin-top: 20px;
      font-size: 14px;
      color: #555;
    }
  </style>
</head>
<body>

<h2>Contract Signing</h2>

<button id="signBtn">✍️ Sign Contract</button>

<div id="status" class="status"></div>

<div id="legalStamp">
  <p><strong>Signed At:</strong> <span id="signedAt"></span></p>
  <p><strong>Device Hash:</strong> <span id="deviceHash"></span></p>
</div>

<script>
/* ---------- SAFE VARIABLE SETUP ---------- */
const signBtn = document.getElementById("signBtn");
const statusEl = document.getElementById("status");
const legalStamp = document.getElementById("legalStamp");

/* ---------- READ URL PARAMS ---------- */
const params = new URLSearchParams(window.location.search);
const fileId = params.get("fileId");
const token = params.get("token");

if (!fileId || !token) {
  statusEl.textContent = "❌ Invalid signing link";
  statusEl.className = "status error";
  signBtn.style.display = "none";
}

/* ---------- MOCK FINGERPRINT (SAFE) ---------- */
async function getDeviceFingerprint() {
  return crypto.randomUUID();
}

/* ---------- CLICK HANDLER ---------- */
signBtn.onclick = async () => {
  try {
    signBtn.disabled = true;
    signBtn.textContent = "Signing…";

    const signedAt = new Date().toISOString();
    const deviceFingerprint = await getDeviceFingerprint();

    const res = await fetch(
      "https://virtgen.app.n8n.cloud/webhook/contract-sign",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          fileId,
          signToken: token,
          contractor_signed_at: signedAt,
          contractor_device_fingerprint: deviceFingerprint,
          contractor_intent:
            "I have read, understood, and agree to be legally bound by this contract"
        })
      }
    );

    if (!res.ok) throw new Error("Webhook failed");

    statusEl.textContent = "✅ Contract signed successfully";
    statusEl.className = "status success";

    signBtn.style.display = "none";
    document.getElementById("signedAt").textContent = signedAt;
    document.getElementById("deviceHash").textContent = deviceFingerprint;
    legalStamp.style.display = "block";

  } catch (err) {
    console.error(err);
    statusEl.textContent = "❌ Signing failed. Please try again.";
    statusEl.className = "status error";
    signBtn.disabled = false;
    signBtn.textContent = "✍️ Sign Contract";
  }
};
</script>

</body>
</html>
